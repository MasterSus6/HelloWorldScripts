-- Auto Sprint Reactive v4.2 (optimized & cleaner)
print("[ðŸš€ Auto Sprint v4.2] Loading...")

-- CONFIG
local DISTANCE_THRESHOLD = 110
local SPEED_THRESHOLD = 12
local HYSTERESIS_TIME = 0.1
local DECISION_INTERVAL = 0.08
local MIN_STAMINA = 1
local STAMINA_RECOVER_TIME = 0.5
local AUTO_SPRINT_TAP = true
local TOGGLE_KEY = Enum.KeyCode.C

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

local VirtualInputManager
pcall(function() VirtualInputManager = game:GetService("VirtualInputManager") end)

-- STATE
local player = Players.LocalPlayer
local char, hrp
local killersFolder
local sprintModule
local sprintKeycode = Enum.KeyCode.LeftShift

local lastPos = {}
local velCache = {}
local sprinting = false
local autoOn = true
local activeThreat = false

local lastDecision = 0
local lastThreat = 0
local staminaLowTime = 0

--========================================================--
--   CLEAN GUI TOGGLE for Auto Sprint v4.2  (anti-dupe)   --
--========================================================--

-- evita duas execuÃ§Ãµes da GUI
if getgenv().AS_GUI_LOADED then
    warn("AutoSprint GUI jÃ¡ carregada. Abortando duplicata.")
    return
end
getgenv().AS_GUI_LOADED = true

-- usa a variÃ¡vel 'autoOn' do script principal
getgenv().AUTOSPRINT_TOGGLE = getgenv().AUTOSPRINT_TOGGLE or true

-- SERVICES
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer

-- GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoSprintGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player:WaitForChild("PlayerGui")

-- MAIN FRAME
local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 200, 0, 70)
Frame.Position = UDim2.new(0.5, -100, 0.8, 0)
Frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Frame.BorderSizePixel = 0
Frame.BackgroundTransparency = 0.15
Frame.Parent = ScreenGui

-- rounded corners
Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 12)

-- DRAG
local dragging, dragStart, startPos
Frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
    end
end)
Frame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)
game:GetService("UserInputService").InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- TITLE
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 28)
Title.Position = UDim2.new(0, 0, 0, 0)
Title.Text = "Auto Sprint"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.BackgroundTransparency = 1
Title.Parent = Frame

-- BUTTON
local Button = Instance.new("TextButton")
Button.Size = UDim2.new(1, -20, 0, 30)
Button.Position = UDim2.new(0, 10, 0, 32)
Button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Button.TextColor3 = Color3.new(1, 1, 1)
Button.Font = Enum.Font.Gotham
Button.TextSize = 16
Button.Text = getgenv().AUTOSPRINT_TOGGLE and "Auto Sprint: ON" or "Auto Sprint: OFF"
Button.Parent = Frame
Instance.new("UICorner", Button).CornerRadius = UDim.new(0, 10)

-- BUTTON ANIMATION
local function animate(btn, active)
    local targetColor = active and Color3.fromRGB(40, 180, 60) or Color3.fromRGB(180, 50, 50)
    TweenService:Create(btn, TweenInfo.new(0.18, Enum.EasingStyle.Sine), {
        BackgroundColor3 = targetColor
    }):Play()
end

-- apply color on load
animate(Button, getgenv().AUTOSPRINT_TOGGLE)

-- CLICK HANDLER
Button.MouseButton1Click:Connect(function()
    getgenv().AUTOSPRINT_TOGGLE = not getgenv().AUTOSPRINT_TOGGLE
    getgenv().autoOn = getgenv().AUTOSPRINT_TOGGLE  -- comunica com o script principal

    Button.Text = getgenv().AUTOSPRINT_TOGGLE and "Auto Sprint: ON" or "Auto Sprint: OFF"
    animate(Button, getgenv().AUTOSPRINT_TOGGLE)
end)

---------------------------------------------------------------------
-- HELPERS
---------------------------------------------------------------------

local function safeRequireSprint()
	local ok, mod = pcall(function()
		return require(ReplicatedStorage.Systems.Character.Game.Sprinting)
	end)
	if not ok or not mod then return nil end

	task.spawn(function()
		for _ = 1, 50 do
			if mod.DefaultsSet then break end
			task.wait(0.03)
		end
	end)

	return mod
end

local function keyFromString(name)
	for _, k in ipairs(Enum.KeyCode:GetEnumItems()) do
		if k.Name == name then return k end
	end
end

local function sendKey(isDown)
	if not VirtualInputManager then return false end
	local ok = pcall(function()
		VirtualInputManager:SendKeyEvent(isDown, sprintKeycode, false, game)
	end)
	return ok
end

local function sprintStart()
	if not sendKey(true) and sprintModule then
		sprintModule.IsSprinting = true
		if sprintModule.__sprintedEvent then pcall(function() sprintModule.__sprintedEvent:Fire(true) end) end
	end
end

local function sprintStop()
	if not sendKey(false) and sprintModule then
		sprintModule.IsSprinting = false
		if sprintModule.__sprintedEvent then pcall(function() sprintModule.__sprintedEvent:Fire(false) end) end
	end
end

---------------------------------------------------------------------
-- VELOCITY
---------------------------------------------------------------------

local function getSpeed(part)
	local now = tick()
	local last = lastPos[part]
	local pos = part.Position

	if not last then
		lastPos[part] = {pos = pos, t = now}
		velCache[part] = 0
		return 0
	end

	local dt = now - last.t
	if dt <= 0 then return velCache[part] end

	local raw = (pos - last.pos).Magnitude / dt
	local smoothed = velCache[part] * 0.55 + raw * 0.45

	-- reject absurd spikes
	if smoothed > 400 then smoothed = velCache[part] end

	lastPos[part] = {pos = pos, t = now}
	velCache[part] = smoothed

	return smoothed
end

---------------------------------------------------------------------
-- CHARACTER SETUP
---------------------------------------------------------------------

local function refreshKillers()
	local w = workspace
	killersFolder =
		w:FindFirstChild("Players") and w.Players:FindFirstChild("Killers")
		or w:FindFirstChild("Killers")

	if killersFolder then
		print("AutoSprint: Killers =", killersFolder:GetFullName())
	else
		warn("AutoSprint: Killers not found yet.")
	end
end

local function onCharacter(charNew)
	char = charNew
	hrp = char and char:WaitForChild("HumanoidRootPart", 5)

	-- keybind
	local ok, bind = pcall(function()
		local pd = player:WaitForChild("PlayerData", 5)
		return pd.Settings.Keybinds.Sprinting.Value
	end)

	if ok then
		sprintKeycode = keyFromString(bind) or Enum.KeyCode.LeftShift
	end

	-- sprint module
	sprintModule = safeRequireSprint()

	print("AutoSprint: Character ready | Key:", sprintKeycode.Name)
end

if player.Character then
	onCharacter(player.Character)
end
player.CharacterAdded:Connect(onCharacter)

workspace.ChildAdded:Connect(function(c)
	if c.Name == "Players" or c.Name == "Killers" then
		task.wait(0.1)
		refreshKillers()
	end
end)

refreshKillers()

---------------------------------------------------------------------
-- MAIN LOOP
---------------------------------------------------------------------

RunService.Heartbeat:Connect(function()
	local now = tick()

	-- global toggle
	if not autoOn then
		if sprinting then sprintStop() sprinting = false end
		return
	end

	if not char or not hrp or not killersFolder then
		return
	end

-- stamina
local stamina = sprintModule and (sprintModule.Stamina or sprintModule.MaxStamina) or math.huge

-- if stamina exactly 100 â†’ force sprint for 0.5 seconds
if stamina == 100 and AUTO_SPRINT_TAP then
	if not sprinting then
		sprintStart()
		sprinting = true
	end
	-- lock sprint for 0.5s without blocking the script
	staminaLowTime = now + 0.5
	return
end

-- low stamina: stop sprint and start recovery timer
if stamina < MIN_STAMINA then
	if sprinting then
		sprintStop()
		sprinting = false
	end
	staminaLowTime = now
	return
end

-- recovery cooldown (normal system)
if now < staminaLowTime then
	return
end

	-- throttle decision rate
	if now - lastDecision < DECISION_INTERVAL then return end
	lastDecision = now

	-- scan killers
	local threat = false
	local nearest = math.huge
	local topSpeed = 0

	for _, k in ipairs(killersFolder:GetChildren()) do
		local root = k:FindFirstChild("HumanoidRootPart") or k.PrimaryPart
		if root and root:IsA("BasePart") then
			local dist = (hrp.Position - root.Position).Magnitude
			if dist <= DISTANCE_THRESHOLD then
				local spd = getSpeed(root)
				if spd > topSpeed then topSpeed = spd end
				if spd > SPEED_THRESHOLD then
					threat = true
					if dist < nearest then nearest = dist end
				end
			end
		end
	end

	-- hysteresis
	if threat then
		activeThreat = true
		lastThreat = now
	elseif now - lastThreat > HYSTERESIS_TIME then
		activeThreat = false
	end

	-- control sprint
	if activeThreat and not sprinting then
		sprintStart()
		sprinting = true

	elseif not activeThreat and sprinting then
		sprintStop()
		sprinting = false
	end
end)

---------------------------------------------------------------------
-- TOGGLE KEY
---------------------------------------------------------------------

UserInputService.InputBegan:Connect(function(i, g)
	if not g and i.KeyCode == TOGGLE_KEY then
		autoOn = not autoOn
		print("AutoSprint:", autoOn and "ON" or "OFF")

		if not autoOn and sprinting then
			sprintStop()
			sprinting = false
		end
	end
end)

print("[ðŸš€ Auto Sprint Reactive v4.2] Done!")

